(* ::Package:: *)

(* May-Leonard 3-species competitive dynamics with CRN analysis *)
(* This is a non-standard epidemic model where ALL variables are "infected" *)
(* (there is no susceptible compartment, DFE is identically zero) *)

(* ========================================================================== *)
(* PART 1: SYMBOLIC MODEL (general al, be parameters) *)
(* ========================================================================== *)

ClearAll["Global`*"];

(* General May-Leonard ODE system from tex:
   dot{x}_1 = x_1(1 - x_1 - al*x_2 - be*x_3)
   dot{x}_2 = x_2(1 - be*x_1 - x_2 - al*x_3)
   dot{x}_3 = x_3(1 - al*x_1 - be*x_2 - x_3)

   For al < 1 < be, boundary equilibria form heteroclinic cycle causing persistence failure *)

Print["========== SYMBOLIC MAY-LEONARD MODEL =========="];
Print["ODE: x1'=x1*(1-x1-al*x2-be*x3), x2'=x2*(1-be*x1-x2-al*x3), x3'=x3*(1-al*x1-be*x2-x3)"];

(* ========================================================================== *)
(* BOUNDARY EQUILIBRIA AND STABILITY ANALYSIS *)
(* ========================================================================== *)

Print["\n========== EQUILIBRIA: E1=(1,0,0), E2=(0,1,0), E3=(0,0,1) =========="];

(* Jacobian at E1=(1,0,0) *)
Print["\nJac at E1=(1,0,0):"];
J1 = {{-1, -al, -be}, {0, 1-be, 0}, {0, 0, 1-al}};
Print["J1=", J1 // MatrixForm, " eig=", Eigenvalues[J1]];
Print["For al<1<be: eig=(-1, 1-be<0, 1-al>0) => SADDLE"];

(* Jacobian at E2=(0,1,0) *)
Print["\nJac at E2=(0,1,0):"];
J2 = {{1-al, 0, 0}, {-be, -1, -al}, {0, 0, 1-be}};
Print["J2=", J2 // MatrixForm, " eig=", Eigenvalues[J2]];
Print["For al<1<be: eig=(-1, 1-al>0, 1-be<0) => SADDLE"];

(* Jacobian at E3=(0,0,1) *)
Print["\nJac at E3=(0,0,1):"];
J3 = {{1-be, 0, 0}, {0, 1-al, 0}, {-al, -be, -1}};
Print["J3=", J3 // MatrixForm, " eig=", Eigenvalues[J3]];
Print["For al<1<be: eig=(-1, 1-al>0, 1-be<0) => SADDLE"];

Print["\n========== HETEROCLINIC CYCLE =========="];
Print["Condition: al<1<be => E1->E2->E3->E1 heteroclinic cycle => PERSISTENCE FAILURE"];

(* ========================================================================== *)
(* PART 2: NUMERICAL CASE (al=0.8, be=1.2) AND CRN REPRESENTATION *)
(* ========================================================================== *)

Print["\n========== NUMERICAL CASE: al=0.8, be=1.2 =========="];

SetDirectory[NotebookDirectory[]];
AppendTo[$Path, FileNameJoin[{$HomeDirectory, "Dropbox", "EpidCRNmodels"}]];
<<EpidCRN`;

al = 0.8;
be = 1.2;
Print["al=", al, " be=", be, " satisfies al<1<be"];

(* ========================================================================== *)
(* REACTION NETWORK *)
(* ========================================================================== *)
(* Each species i: birth (x_i -> 2x_i), death by crowding (2x_i -> x_i), *)
(* competitive interactions with other species *)

RN = {
  "x1" -> 2*"x1",         (* x1 birth *)
  "x1" + "x1" -> "x1",    (* x1 self-limitation *)
  "x1" + "x2" -> "x2",    (* x2 outcompetes x1 *)
  "x1" + "x3" -> "x3",    (* x3 outcompetes x1 *)
  "x2" -> 2*"x2",         (* x2 birth *)
  "x2" + "x2" -> "x2",    (* x2 self-limitation *)
  "x2" + "x3" -> "x3",    (* x3 outcompetes x2 *)
  "x2" + "x1" -> "x1",    (* x1 outcompetes x2 *)
  "x3" -> 2*"x3",         (* x3 birth *)
  "x3" + "x3" -> "x3",    (* x3 self-limitation *)
  "x3" + "x1" -> "x1",    (* x1 outcompetes x3 *)
  "x3" + "x2" -> "x2"     (* x2 outcompetes x3 *)
};

(* Reaction rates (mass-action kinetics) *)
rts = {x1, x1*x1, al*x1*x2, be*x1*x3, x2, x2*x2, al*x2*x3, be*x2*x1,
   x3, x3*x3, al*x3*x1, be*x3*x2};

Print["Reactions and transitions:"];
Print[Transpose[{RN, rts}] // MatrixForm];

(* ========================================================================== *)
(* CRN ANALYSIS *)
(* ========================================================================== *)

{RHS, var, par, cp, mSi, Jx, Jy, cDFE, E0, K, R0A, infVars, ngm} = bdAn[RN, rts];

Print["\nODE system RHS:"];
Print[Table[var[[i]] == RHS[[i]], {i, 1, 3}] // Column];

Print["\nDisease-Free Equilibrium (DFE):"];
Print[E0];
(* NOTE: DFE = {x1->0, x2->0, x3->0} because all variables are "infected" *)
(* This is different from standard epidemic models with susceptible compartments *)

Print["\nNext Generation Matrix K at DFE:"];
Print[K // MatrixForm];
(* NOTE: K is zero matrix because F1=0 at DFE (all populations extinct) *)
(* Standard NGM theory doesn't apply here - need different approach *)

(* ========================================================================== *)
(* ODE SIMULATION *)
(* ========================================================================== *)
(* We expect to see: *)
(* 1. Trajectories spiral toward interior of simplex (heteroclinic cycle) *)
(* 2. min{x1,x2,x3} decreases exponentially -> log plot shows linear decay *)
(* 3. Slow oscillations with species taking turns dominating *)

varT = Through[var[t]];
odes = Thread[D[varT, t] == (RHS /. Thread[var -> varT])];

(* Initial conditions: 4 points in interior of probability simplex *)
inits = {
  {x1[0] == 0.7, x2[0] == 0.2, x3[0] == 0.1},
  {x1[0] == 0.6, x2[0] == 0.3, x3[0] == 0.1},
  {x1[0] == 0.55, x2[0] == 0.25, x3[0] == 0.20},
  {x1[0] == 0.50, x2[0] == 0.40, x3[0] == 0.10}
};

tmax = 2000;
Print["\nSimulating ", Length[inits], " trajectories up to t=", tmax, "..."];
sims = Table[
  NDSolve[Join[odes, init], varT, {t, 0, tmax}, MaxSteps -> 10000],
  {init, inits}
];
Print["Simulation complete."];

(* ========================================================================== *)
(* FIGURE 1: Distance to boundary (heteroclinic cycle signature) *)
(* ========================================================================== *)
(* EXPECTED: Linear decrease in log scale = exponential approach to boundary *)
(* This shows the heteroclinic orbit structure: trajectories approach faces *)
(* of simplex (2-species states) but never reach vertices (1-species states) *)

Print["\n=== FIGURE 1: Heteroclinic cycle signature ==="];
fig1 = Plot[
  Evaluate[Table[
    Log10[Min[x1[t], x2[t], x3[t]] /. sims[[k]][[1]]],
    {k, 1, Length[inits]}
  ]],
  {t, 0, tmax},
  PlotLegends -> Table["init " <> ToString[k], {k, 1, Length[inits]}],
  AxesLabel -> {"time", "log10 min{x1,x2,x3}"},
  PlotLabel -> "Distance to boundary (exponential decay shows heteroclinic structure)",
  ImageSize -> Large,
  PlotRange -> All
];
Print[fig1];

(* ========================================================================== *)
(* FIGURE 2: Time series (rock-paper-scissors oscillations) *)
(* ========================================================================== *)
(* EXPECTED: Slow oscillations where each species dominates in turn *)
(* x1 rises -> x2 suppressed -> x3 rises -> x1 suppressed -> x2 rises -> cycle *)
(* Amplitude grows slowly as trajectory spirals outward toward boundary *)

Print["\n=== FIGURE 2: Rock-paper-scissors dynamics ==="];
sol = sims[[1]][[1]];
fig2 = Plot[
  Evaluate[{x1[t], x2[t], x3[t]} /. sol],
  {t, 0, tmax},
  PlotLegends -> {"x1", "x2", "x3"},
  AxesLabel -> {"time", "population fraction"},
  PlotLabel -> "Three-species oscillations (each dominates in turn)",
  ImageSize -> Large,
  PlotRange -> {{0, tmax}, {0, 1}}
];
Print[fig2];

(* ========================================================================== *)
(* FIGURE 3: Phase portrait on simplex *)
(* ========================================================================== *)
(* EXPECTED: Spiral trajectory from interior toward boundary *)
(* Color shows distance to boundary (darker = closer to extinction of one species) *)
(* Trajectory never reaches corner (single-species state) but approaches edges *)

Print["\n=== FIGURE 3: Phase portrait on probability simplex ==="];
npts = 1000;
tvals = Range[0, tmax, tmax/npts];
x1vals = Table[(x1[t] /. sol) /. t -> tv, {tv, tvals}];
x2vals = Table[(x2[t] /. sol) /. t -> tv, {tv, tvals}];
x3vals = Table[(x3[t] /. sol) /. t -> tv, {tv, tvals}];

(* Project barycentric coordinates to 2D equilateral triangle *)
v1 = {0.0, 0.0};                (* vertex for x1=1 *)
v2 = {1.0, 0.0};                (* vertex for x2=1 *)
v3 = {0.5, Sqrt[3]/2};          (* vertex for x3=1 *)
pts2D = Table[
  x1vals[[i]]*v1 + x2vals[[i]]*v2 + x3vals[[i]]*v3,
  {i, 1, Length[tvals]}
];

fig3 = ListPlot[pts2D,
  PlotStyle -> {PointSize[0.001], Opacity[0.6]},
  AspectRatio -> Automatic,
  Axes -> False,
  Frame -> True,
  FrameLabel -> {"Triangle shows simplex x1+x2+x3=1", "Spiral toward boundary"},
  PlotLabel -> "Heteroclinic orbit on simplex (approaches but never reaches corners)",
  ImageSize -> Large
];
Print[fig3];

(* Draw simplex boundary *)
boundary = Graphics[{Thick, Line[{v1, v2, v3, v1}]}];
fig3withBoundary = Show[boundary, fig3];
Print[fig3withBoundary];

Print["\n=== INTERPRETATION ==="];
Print["1. Fig 1: Linear in log scale => exponential approach to boundary"];
Print["2. Fig 2: Each species dominates cyclically (rock-paper-scissors)"];
Print["3. Fig 3: Trajectory spirals outward, approaching edges but not corners"];
Print["This is a HETEROCLINIC CYCLE connecting saddle points on simplex faces"];



